<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="client_id" content="104588881" />
    <meta name="redirect_uri" content="https://www.onecourse.top/CourseView" />
    <meta name="scope" content="https://www.huawei.com/auth/drive.appdata" />
    <title>一课表登录</title>
</head>

<body style="background: linear-gradient(220deg, #28b7ff, #0066ff);">
    <div style="display: flex;align-items: center;justify-content: center;width: 100%;height: 100%;">
        <button id="hwlogin" onclick=redirect() class="loginBtn">登录华为账号</button>
    </div>
</body>

<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="./jquery.cookie.min.js"></script>
<script src="https://unpkg.com/@sifrr/storage@0.0.9/dist/sifrr.storage.min.js"></script>
<script>
    var storage;
</script>
<script>
    var num = 0
    function check() {
        if (num === 0) {
            window.location.href = 'main.html'
        }
    }
    async function download() {
        const allKey = await storage.keys()
        if (allKey.length != 0) return;
        $.ajax({
            url: 'https://driveapis.cloud.huawei.com.cn/drive/v1/files?fields=*&containers=applicationData',
            contentType: 'application/json',
            method: 'get',
            headers: {
                'Authorization': 'Bearer ' + $.cookie('AuthToken')
            },
            success(data, status) {
                if (status == 'success') {
                    console.log(JSON.stringify(data))
                    let files = data.files
                    let courses = []
                    files.forEach(file => {
                        if (file.fileName.split('-')[0] === 'Course') {
                            courses.push(file)
                        }
                    })
                    num = courses.length
                    courses.forEach(course => {
                        $.ajax({
                            url: course.contentDownloadLink,
                            contentType: 'application/json',
                            method: 'get',
                            headers: {
                                'Authorization': 'Bearer ' + $.cookie('AuthToken')
                            },
                            success(courseData, status_) {
                                if (status_ == 'success') {
                                    storage.set(course.fileName.split('-')[1], courseData)
                                }
                                num--
                                check()
                            }
                        })
                    })
                } else {
                    console.error('list error')
                }
            },
            error() {
                $.removeCookie('AuthToken')
                alert('登录过期')
                window.location.reload()
            }
        })
    }
</script>
<script>
    window.addEventListener('load', async function () {
        storage = Sifrr.Storage.getStorage({ 
            priority: ['indexeddb'],
            name: 'Course'
        })

        const url = new URL(window.location)
        const query = url.searchParams
        storage.keys().then(allKey => {
            if (allKey.length != 0) {
                window.location.href = 'main.html'
            }
        })
        if (query.has('code')) {
            $.ajax({
                url: 'https://www.onecourse.top/authLogin',
                contentType: 'application/json',
                data: JSON.stringify({
                    code: query.get('code')
                }),
                method: 'post',
                success(data, status, _) {
                    if (status == 'success') {
                        $.cookie('AuthToken', data.access_token, { expires: new Date(new Date().getTime() + 60 * 60 * 1000) })
                        window.location.href = 'https://www.onecourse.top/CourseView'
                    } else {
                        alert('登录错误，请重试')
                    }
                },
                error() {
                    alert('登录错误，请重试')
                }
            })
        }
        if ($.cookie('AuthToken') != undefined) {
            download()
        }
    });
    var client_id = '', redirect_uri = '', scope = '';
    for (var metas = document.getElementsByTagName("meta"), i = 0; i < metas.length; ++i) {
        switch (metas[i].name) {
            case 'client_id':
                client_id = metas[i].content;
                break;
            case 'redirect_uri':
                redirect_uri = metas[i].content;
                break;
            case 'scope':
                scope = metas[i].content;
                break;
            default: break
        }
    }
    var redirectUrl = 'https://oauth-login.cloud.huawei.com/oauth2/v3/authorize?' +
        'response_type=code&access_type=offline&state=state_parameter_passthrough_value&client_id=' + client_id + '&redirect_uri=' + redirect_uri + '&scope=' + scope;
    function redirect() {
        window.location.href = redirectUrl;
    }
</script>

<style>
    html,
    body {
        width: 100%;
        height: 100%;
        margin: 0;
    }

    .loginBtn {
        color: white;
        border: none;
        border-radius: 30px;
        background-color: red;
        padding: 12px 24px;
        font-size: 20px;
        transition-duration: 300ms;
    }

    .loginBtn:hover {
        opacity: 0.7;
    }
</style>

</html>