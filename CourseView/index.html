<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="client_id" content="104588881" />
    <meta name="redirect_uri" content="https://www.onecourse.top/CourseView" />
    <meta name="scope" content="https://www.huawei.com/auth/drive.appdata" />
    <title>一课表登录</title>
</head>

<body style="background: linear-gradient(220deg, #28b7ff, #0066ff);">
    <div id="app" style="width: 100%;height: 100%;">
        <div style="display: flex;align-items: center;justify-content: center;width: 100%;height: 100%;" v-if="!isLogin">
            <button id="hwlogin" onclick=redirect() class="loginBtn">登录华为账号</button>
        </div>
        <div style="display: flex;align-items: center;box-sizing: border-box;
        width: 100%;height: 100%;padding: 16px;flex-direction: column;" v-if="isLogin">
            <text style="color: white;font-size: 16px;">本网站数据来源于云空间</text>
        </div>
    </div>
</body>

<script src="https://cdn.staticfile.org/vue/2.2.2/vue.min.js"></script>
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="jquery.cookie.min.js"></script>
<script>
    var vm = new Vue({
        el: '#app',
        data: {
            isLogin: false
        },
        methods: {

        }
    })
</script>
<script>
    function list() {
        $.ajax({
            url: 'https://driveapis.cloud.huawei.com.cn/drive/v1/files?fields=*&containers=drive',
            contentType: 'application.json',
            method: 'post',
            headers: {
                'Authorization': 'Bearer ' + $.cookie('AuthToken')
            },
            success(data, status) {
                if (status == 'success') {
                    console.log(JSON.stringify(data))
                } else {
                    console.error('list error')
                }
            }
        })
    }
</script>
<script>
    const url = new URL(window.location)
    const query = url.searchParams
    if (query.has('code')) {
        $.ajax({
            url: 'https://www.onecourse.top/authLogin',
            contentType: 'application/json',
            data: JSON.stringify({
                code: query.get('code')
            }),
            method: 'post',
            success(data, status, _) {
                if (status == 'success') {
                    $.cookie('AuthToken', data.access_token, { expires: new Date(new Date().getTime() + 60 * 60 * 1000) })
                    window.location.href = 'https://www.onecourse.top/CourseView'
                } else {
                    alert('登录错误，请重试')
                }
            }
        })
    } else {
        list()
    }
    if ($.cookie('AuthToken') != undefined) {
        $('#loginPage').css('display', 'none')
    }
    var client_id = '', redirect_uri = '', scope = '';
    for (var metas = document.getElementsByTagName("meta"), i = 0; i < metas.length; ++i) {
        switch (metas[i].name) {
            case 'client_id':
                client_id = metas[i].content;
                break;
            case 'redirect_uri':
                redirect_uri = metas[i].content;
                break;
            case 'scope':
                scope = metas[i].content;
                break;
            default: break
        }
    }
    var redirectUrl = 'https://oauth-login.cloud.huawei.com/oauth2/v3/authorize?' +
        'response_type=code&access_type=offline&state=state_parameter_passthrough_value&client_id=' + client_id + '&redirect_uri=' + redirect_uri + '&scope=' + scope;
    function redirect() {
        window.location.href = redirectUrl;
    }
</script>

<style>
    html,
    body {
        width: 100%;
        height: 100%;
        margin: 0;
    }

    .loginBtn {
        color: white;
        border: none;
        border-radius: 30px;
        background-color: red;
        padding: 8px 16px;
        transition-duration: 300ms;
    }

    .loginBtn:hover {
        opacity: 0.7;
    }
</style>

</html>